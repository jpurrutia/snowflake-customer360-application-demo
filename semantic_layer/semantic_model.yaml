# ============================================================================
# Semantic Model for Snowflake Cortex Analyst
# ============================================================================
# Purpose: Enable natural language queries over Customer 360 credit card analytics
#
# Usage:
#   - Ask questions in plain English via Cortex Analyst
#   - Examples: "What is the average spend in California?"
#               "Show me customers at high risk of churning"
#
# Deployment:
#   ./deploy_semantic_model.sh
# ============================================================================

name: customer_analytics_semantic_model
description: "Semantic layer for Customer 360 credit card analytics enabling natural language queries"
version: "1.0"

# ============================================================================
# Base Tables
# ============================================================================

tables:
  # ==========================================================================
  # Customer 360 Profile (Primary Table)
  # ==========================================================================
  - name: customer_360_profile
    base_table: CUSTOMER_ANALYTICS.GOLD.CUSTOMER_360_PROFILE
    description: "Complete customer profile with demographics, spending patterns, segmentation, and ML-powered churn risk scores"

    dimensions:
      # Customer Identifiers
      - name: customer_id
        type: string
        description: "Unique customer identifier (format: CUST########)"
        synonyms: ["customer number", "account id", "customer code", "cust id"]

      - name: full_name
        type: string
        description: "Customer full name (first + last)"
        synonyms: ["name", "customer name", "account holder"]

      # Demographics
      - name: age
        type: number
        description: "Customer age in years (18-100)"
        synonyms: ["customer age", "age group"]

      - name: state
        type: string
        description: "US state of residence (two-letter code: CA, NY, TX, etc.)"
        synonyms: ["location", "region", "state code", "residence state"]

      - name: city
        type: string
        description: "City of residence"
        synonyms: ["customer city", "location city"]

      - name: employment_status
        type: string
        description: "Current employment status"
        synonyms: ["employment", "job status", "work status"]
        allowed_values:
          - "Full-Time"
          - "Part-Time"
          - "Self-Employed"
          - "Retired"
          - "Unemployed"

      # Account Details
      - name: card_type
        type: string
        description: "Credit card product type (Standard or Premium)"
        synonyms: ["card product", "card tier", "card level"]
        allowed_values: ["Standard", "Premium"]

      - name: credit_limit
        type: number
        description: "Customer credit limit in dollars ($5,000 - $50,000)"
        synonyms: ["credit line", "spending limit"]
        format: "currency"

      - name: account_open_date
        type: date
        description: "Date when credit card account was opened"
        synonyms: ["account start date", "open date", "signup date"]

      # Segmentation
      - name: customer_segment
        type: string
        description: "Behavioral segment based on spending patterns and demographics"
        synonyms: ["segment", "customer type", "customer category", "behavior segment"]
        allowed_values:
          - "High-Value Travelers"
          - "Stable Mid-Spenders"
          - "Budget-Conscious"
          - "Declining"
          - "New & Growing"

      # Churn Risk (ML Model)
      - name: churn_risk_category
        type: string
        description: "Churn risk level from ML model (Low/Medium/High Risk)"
        synonyms: ["risk level", "churn category", "retention risk", "churn bucket"]
        allowed_values: ["Low Risk", "Medium Risk", "High Risk", "Not Scored"]

      # Recency Status
      - name: recency_status
        type: string
        description: "Customer activity recency classification"
        synonyms: ["activity status", "engagement status", "customer status"]
        allowed_values:
          - "Active (30 days)"
          - "Recent (60 days)"
          - "At Risk (90 days)"
          - "Inactive (90+ days)"

      # Spending Profile
      - name: spending_profile
        type: string
        description: "Spending pattern classification based on category preferences"
        synonyms: ["spending type", "purchase pattern", "spending category"]
        allowed_values: ["Travel-Focused", "Necessity-Focused", "Balanced"]

      # Campaign Eligibility Flags
      - name: eligible_for_retention_campaign
        type: boolean
        description: "Flag indicating if customer is eligible for retention campaign"
        synonyms: ["retention eligible", "churn campaign eligible"]

      - name: eligible_for_premium_campaign
        type: boolean
        description: "Flag indicating if customer is eligible for premium upgrade campaign"
        synonyms: ["premium eligible", "upgrade eligible"]

    metrics:
      # Lifetime Metrics
      - name: lifetime_value
        type: number
        aggregation: sum
        description: "Total amount spent by customer over entire relationship (all-time spend)"
        synonyms: ["LTV", "total spend", "total spending", "customer value", "total revenue"]
        format: "currency"

      - name: total_transactions
        type: number
        aggregation: sum
        description: "Total number of transactions over customer lifetime"
        synonyms: ["transaction count", "number of purchases", "transaction total"]

      - name: avg_transaction_value
        type: number
        aggregation: avg
        description: "Average dollar amount per transaction (ATV)"
        synonyms: ["ATV", "average purchase", "typical transaction", "avg spend per transaction"]
        format: "currency"

      - name: customer_age_days
        type: number
        aggregation: avg
        description: "Days between first and last transaction (customer lifespan)"
        synonyms: ["customer lifespan", "days active", "relationship duration"]

      # Recent Activity (90-day window)
      - name: spend_last_90_days
        type: number
        aggregation: sum
        description: "Total spending in last 90 days (recent period)"
        synonyms: ["recent spend", "quarterly spend", "90 day spend", "last 3 months spend"]
        format: "currency"

      - name: spend_prior_90_days
        type: number
        aggregation: sum
        description: "Total spending in prior 90 days (days 91-180)"
        synonyms: ["previous period spend", "prior quarter spend"]
        format: "currency"

      - name: spend_change_pct
        type: number
        aggregation: avg
        description: "Percentage change in spending (last 90 vs prior 90 days). Negative = declining"
        synonyms: ["spending trend", "spend growth", "spending change", "spend delta"]
        format: "percentage"

      - name: avg_monthly_spend
        type: number
        aggregation: avg
        description: "Average monthly spending amount"
        synonyms: ["monthly spend", "typical monthly spend", "average spend per month"]
        format: "currency"

      # Recency
      - name: days_since_last_transaction
        type: number
        aggregation: avg
        description: "Number of days since customer's last transaction (higher = more at risk)"
        synonyms: ["recency", "last activity", "days inactive", "days since purchase"]

      # Churn Risk (ML Model)
      - name: churn_risk_score
        type: number
        aggregation: avg
        description: "ML-predicted churn risk probability on 0-100 scale (higher = more likely to churn)"
        synonyms: ["risk score", "churn probability", "retention score", "churn likelihood"]
        format: "number"

      # Category Preferences
      - name: travel_spend_pct
        type: number
        aggregation: avg
        description: "Percentage of spending on travel categories (Airlines, Hotels, Travel)"
        synonyms: ["travel percentage", "travel spend ratio"]
        format: "percentage"

      - name: necessities_spend_pct
        type: number
        aggregation: avg
        description: "Percentage of spending on necessities (Grocery, Gas, Utilities, Healthcare)"
        synonyms: ["necessities percentage", "essential spend ratio"]
        format: "percentage"

      # Credit Utilization
      - name: credit_utilization_pct
        type: number
        aggregation: avg
        description: "Monthly spend as percentage of credit limit (utilization rate)"
        synonyms: ["utilization", "credit usage", "limit usage"]
        format: "percentage"

      # Count Metric
      - name: customer_count
        type: number
        aggregation: count
        description: "Count of distinct customers"
        synonyms: ["number of customers", "customer total", "count of customers", "how many customers"]

  # ==========================================================================
  # Fact Transactions (Detailed Transaction Data)
  # ==========================================================================
  - name: fct_transactions
    base_table: CUSTOMER_ANALYTICS.GOLD.FCT_TRANSACTIONS
    description: "Individual credit card transactions (13.5M rows, 18 months of history)"

    dimensions:
      # Transaction Identifiers
      - name: transaction_key
        type: string
        description: "Unique transaction surrogate key"
        synonyms: ["transaction id", "txn key"]

      - name: transaction_id
        type: string
        description: "Original transaction identifier (format: TXN###########)"
        synonyms: ["txn id", "transaction number"]

      # Time Dimensions
      - name: transaction_date
        type: date
        description: "Date and time of transaction"
        synonyms: ["transaction time", "purchase date", "txn date", "transaction timestamp"]

      # Merchant Details
      - name: merchant_name
        type: string
        description: "Name of merchant where transaction occurred"
        synonyms: ["store", "vendor", "merchant", "retailer"]

      - name: channel
        type: string
        description: "Transaction channel (Online, In-Store, Mobile)"
        synonyms: ["purchase channel", "transaction channel", "sales channel"]
        allowed_values: ["Online", "In-Store", "Mobile"]

      - name: status
        type: string
        description: "Transaction approval status"
        synonyms: ["transaction status", "approval status"]
        allowed_values: ["approved", "declined"]

    metrics:
      - name: transaction_amount
        type: number
        aggregation: sum
        description: "Transaction dollar amount (approved transactions only)"
        synonyms: ["purchase amount", "spend", "amount", "transaction value", "sales amount"]
        format: "currency"

      - name: transaction_count
        type: number
        aggregation: count
        description: "Number of transactions"
        synonyms: ["transaction total", "purchase count", "number of transactions", "txn count"]

  # ==========================================================================
  # Merchant Category Dimension
  # ==========================================================================
  - name: dim_merchant_category
    base_table: CUSTOMER_ANALYTICS.GOLD.DIM_MERCHANT_CATEGORY
    description: "Merchant category classification with hierarchies"

    dimensions:
      - name: category_key
        type: string
        description: "Unique merchant category surrogate key"

      - name: category_name
        type: string
        description: "Merchant category name (Grocery, Travel, Dining, etc.)"
        synonyms: ["category", "merchant type", "spending category", "purchase category"]
        allowed_values:
          - "Travel"
          - "Dining"
          - "Hotels"
          - "Airlines"
          - "Grocery"
          - "Gas"
          - "Utilities"
          - "Healthcare"
          - "Entertainment"
          - "Retail"
          - "Other"

      - name: category_group
        type: string
        description: "High-level category grouping (Leisure, Necessities, Other)"
        synonyms: ["category type", "category group", "spending type"]
        allowed_values: ["Leisure", "Necessities", "Other"]

      - name: is_discretionary
        type: boolean
        description: "Whether spending is discretionary (TRUE) or essential (FALSE)"
        synonyms: ["discretionary flag", "optional spending"]

  # ==========================================================================
  # Customer Segments Table
  # ==========================================================================
  - name: customer_segments
    base_table: CUSTOMER_ANALYTICS.GOLD.CUSTOMER_SEGMENTS
    description: "Customer behavioral segmentation with rolling 90-day window metrics"

    dimensions:
      - name: customer_segment
        type: string
        description: "Customer segment classification"
        synonyms: ["segment", "customer type"]
        allowed_values:
          - "High-Value Travelers"
          - "Stable Mid-Spenders"
          - "Budget-Conscious"
          - "Declining"
          - "New & Growing"

      - name: segment_assigned_date
        type: date
        description: "Date when segment was assigned (updated daily)"
        synonyms: ["segment date", "classification date"]

    metrics:
      - name: tenure_months
        type: number
        aggregation: avg
        description: "Months since first transaction (customer tenure)"
        synonyms: ["customer tenure", "months active", "relationship length"]

# ============================================================================
# Relationships between Tables
# ============================================================================

relationships:
  # Transactions → Customer 360
  - from_table: fct_transactions
    to_table: customer_360_profile
    join_key: customer_id
    join_type: many_to_one
    description: "Each transaction belongs to one customer"

  # Transactions → Merchant Category
  - from_table: fct_transactions
    to_table: dim_merchant_category
    join_key: merchant_category_key
    join_type: many_to_one
    description: "Each transaction has one merchant category"

  # Customer 360 → Customer Segments
  - from_table: customer_360_profile
    to_table: customer_segments
    join_key: customer_id
    join_type: one_to_one
    description: "Each customer has one current segment"

# ============================================================================
# Sample Natural Language Questions
# ============================================================================

sample_questions:
  # Customer Profile Queries
  - "What is the average spend of customers in California?"
  - "Show me customers in Texas spending over $5K per month"
  - "How many High-Value Travelers are there?"
  - "Which customers have a lifetime value over $100,000?"
  - "What is the average age of Premium cardholders?"
  - "Show me retired customers with high credit limits"

  # Churn Risk Queries
  - "Which customers are at highest risk of churning?"
  - "Show me the top 10 customers by churn risk score"
  - "How many customers are in the High Risk churn category?"
  - "What is the average churn risk score for the Declining segment?"
  - "Which High-Value Travelers have high churn risk?"
  - "Show me customers who haven't transacted in over 60 days"

  # Spending Trend Queries
  - "Show me spending trends in the travel category over the last 6 months"
  - "Which merchant categories are most popular among Premium cardholders?"
  - "What's the average transaction value for each customer segment?"
  - "Which customers increased their spending last quarter?"
  - "Show me customers with declining spend trends"

  # Segmentation Queries
  - "Compare lifetime value across customer segments"
  - "Show me Budget-Conscious customers who increased spending"
  - "How many customers in each segment have Premium cards?"
  - "What is the average monthly spend by segment?"
  - "Which segments have the highest churn risk?"

  # Time-Based Queries
  - "What was total spending in the last 90 days?"
  - "Show monthly transaction volume trends"
  - "Which customers are inactive (90+ days since last transaction)?"
  - "What is daily transaction volume?"

  # Campaign Targeting Queries
  - "Show me customers eligible for retention campaigns"
  - "Which Premium cardholders are at risk of churning?"
  - "Find Budget-Conscious customers with high credit utilization"
  - "Show me New & Growing customers with low engagement"

  # Geographic Queries
  - "What is the average lifetime value by state?"
  - "Which states have the highest churn risk?"
  - "Show me top spending cities"
  - "Compare Premium vs Standard card adoption by region"

  # Advanced Analytical Queries
  - "What is the correlation between age and lifetime value?"
  - "Show me the distribution of churn risk scores"
  - "Which spending categories are most predictive of churn?"
  - "Compare spending patterns between High Risk and Low Risk customers"

# ============================================================================
# Query Optimization Hints
# ============================================================================

optimization:
  - table: customer_360_profile
    recommended_filters:
      - "customer_segment"
      - "state"
      - "churn_risk_category"
      - "card_type"
    clustering_keys: ["customer_id"]
    row_count: "~50,000"

  - table: fct_transactions
    recommended_filters:
      - "transaction_date"
      - "status"
    clustering_keys: ["transaction_date"]
    row_count: "~13,500,000"

  - table: dim_merchant_category
    recommended_filters: ["category_group"]
    row_count: "~20"

  - table: customer_segments
    recommended_filters: ["customer_segment"]
    clustering_keys: ["customer_id"]
    row_count: "~50,000"

# ============================================================================
# Metadata
# ============================================================================

metadata:
  last_updated: "2025-11-12"
  version: "1.0"
  owner: "Data Analytics Team"
  documentation_url: "https://github.com/your-org/customer-analytics/docs/semantic_layer"
  contact_email: "analytics@yourcompany.com"
